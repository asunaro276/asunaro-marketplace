name: Package Skills

on:
  push:
    branches:
      - main

jobs:
  package-skills:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find and package skills
        id: package
        run: |
          # ã‚¹ã‚­ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢
          skill_dirs=$(find plugins -type d -path "*/skills/*" -not -path "*/skills/*/references*" -not -path "*/skills/*/assets*" -not -path "*/skills/*/scripts*" | grep -v "^plugins/.*/skills$")

          # å„ã‚¹ã‚­ãƒ«ã‚’zipåŒ–
          mkdir -p packaged-skills

          for skill_dir in $skill_dirs; do
            # ã‚¹ã‚­ãƒ«åã‚’å–å¾—ï¼ˆä¾‹: development-plugin/skills/git-operations -> development-plugin_git-operationsï¼‰
            plugin_name=$(echo "$skill_dir" | cut -d'/' -f2)
            skill_name=$(basename "$skill_dir")
            zip_name="${plugin_name}_${skill_name}.zip"

            echo "Packaging: $skill_dir -> $zip_name"

            # ã‚¹ã‚­ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã‚’zipåŒ–
            (cd "$(dirname "$skill_dir")" && zip -r "../../../packaged-skills/$zip_name" "$(basename "$skill_dir")")
          done

          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º
          echo "Packaged skills:"
          ls -lh packaged-skills/

      - name: Upload skill packages as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: skills-packages
          path: packaged-skills/*.zip
          retention-days: 90
          if-no-files-found: error

      - name: Create package summary
        run: |
          echo "# ðŸ“¦ Skills Package Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚ŒãŸã‚¹ã‚­ãƒ«:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for zip_file in packaged-skills/*.zip; do
            file_name=$(basename "$zip_file")
            file_size=$(ls -lh "$zip_file" | awk '{print $5}')
            echo "- \`$file_name\` ($file_size)" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Artifacts ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™" >> $GITHUB_STEP_SUMMARY
